<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QuÃ©bec en Famille - AgrÃ©gateur d'activitÃ©s</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
* { font-family: 'Outfit', sans-serif; box-sizing: border-box; }

/* â”€â”€ Dropdown trigger â”€â”€ */
.dd-trigger {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 14px; border-radius: 10px;
  font-size: 0.82rem; font-weight: 600; cursor: pointer;
  border: 2px solid #e2e8f0; background: #f8fafc; color: #475569;
  transition: all 0.15s; white-space: nowrap; user-select: none;
  width: 100%;
}
.dd-trigger:hover { border-color: #cbd5e1; background: #f1f5f9; }
.dd-trigger.has-value { border-color: #1d4ed8; background: #eff6ff; color: #1d4ed8; }
.dd-trigger.open { border-color: #3b82f6; }
.dd-arrow { margin-left: auto; font-size: 0.7rem; opacity: 0.4; transition: transform 0.2s; }
.dd-trigger.open .dd-arrow { transform: rotate(180deg); opacity: 0.7; }
.dd-badge {
  background: #1d4ed8; color: white; border-radius: 999px;
  font-size: 0.68rem; font-weight: 800; padding: 1px 7px;
}

/* â”€â”€ Dropdown panel â”€â”€ */
.dd-wrapper { position: relative; }
.dd-panel {
  display: none; position: absolute; top: calc(100% + 6px); left: 0;
  background: white; border: 1.5px solid #e2e8f0; border-radius: 12px;
  box-shadow: 0 10px 32px rgba(0,0,0,0.13);
  z-index: 500; min-width: 220px; overflow: hidden;
}
.dd-panel.open { display: block; }

/* â”€â”€ Option items â”€â”€ */
.dd-opt {
  display: flex; align-items: center; gap: 9px;
  padding: 9px 14px; font-size: 0.83rem; font-weight: 500;
  color: #374151; cursor: pointer; transition: background 0.1s;
}
.dd-opt:hover { background: #f0f7ff; }
.dd-opt.selected { background: #dbeafe; color: #1d4ed8; font-weight: 700; }
.dd-opt.is-parent { font-weight: 700; border-top: 1px solid #f3f4f6; }
.dd-opt.is-parent:first-child { border-top: none; }
.dd-opt.is-child { padding-left: 28px; font-size: 0.8rem; color: #4b5563; }
.dd-opt.is-child.selected { color: #1d4ed8; }

/* Checkbox */
.dd-chk {
  width: 16px; height: 16px; min-width: 16px;
  border: 2px solid #d1d5db; border-radius: 4px; background: white;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.12s; flex-shrink: 0;
}
.dd-opt.selected .dd-chk { background: #1d4ed8; border-color: #1d4ed8; }
.dd-opt.selected .dd-chk::after {
  content: ''; display: block; width: 8px; height: 4px;
  border-left: 2px solid white; border-bottom: 2px solid white;
  transform: rotate(-45deg) translateY(-1px);
}
/* Radio style for PÃ©riode */
.dd-opt.radio-opt .dd-chk { border-radius: 999px; }
.dd-opt.radio-opt.selected .dd-chk::after {
  width: 6px; height: 6px; border: none;
  background: white; border-radius: 999px; transform: none;
}

/* Divider + clear inside panel */
.dd-divider { height: 1px; background: #f1f5f9; margin: 4px 0; }
.dd-clear {
  display: block; padding: 8px 14px; font-size: 0.75rem;
  color: #94a3b8; cursor: pointer; text-align: center;
  border-top: 1px solid #f1f5f9; transition: color 0.1s;
}
.dd-clear:hover { color: #ef4444; }

/* â”€â”€ Cards â”€â”€ */
.event-card {
  background: white; border-radius: 16px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.07);
  overflow: hidden; border: 1px solid #f1f5f9;
  transition: transform 0.18s, box-shadow 0.18s;
  display: block; text-decoration: none; color: inherit;
}
.event-card:hover { transform: translateY(-4px); box-shadow: 0 10px 28px rgba(0,0,0,0.13); }

.date-badge {
  position: absolute; top: 10px; right: 10px;
  padding: 3px 9px; border-radius: 6px;
  font-size: 0.66rem; font-weight: 700;
  backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
  line-height: 1.5;
}

/* Theme colours */
.tc-arts    { color: #2563eb; } .bc-arts    { background: rgba(37,99,235,0.18);  color: #1d4ed8; }
.tc-cinema  { color: #7c3aed; } .bc-cinema  { background: rgba(124,58,237,0.18); color: #6d28d9; }
.tc-visite  { color: #0891b2; } .bc-visite  { background: rgba(8,145,178,0.18);  color: #0e7490; }
.tc-musique { color: #db2777; } .bc-musique { background: rgba(219,39,119,0.18); color: #be185d; }
.tc-event   { color: #d97706; } .bc-event   { background: rgba(217,119,6,0.18);  color: #b45309; }
.tc-expo    { color: #059669; } .bc-expo    { background: rgba(5,150,105,0.18);  color: #047857; }

/* Summary chips */
.chip {
  display: inline-flex; align-items: center; gap: 5px;
  background: rgba(255,255,255,0.2); border-radius: 999px;
  padding: 3px 10px; font-size: 0.78rem; font-weight: 600; color: white;
}
.chip-x {
  background: none; border: none; cursor: pointer;
  color: rgba(255,255,255,0.6); font-size: 0.9rem; line-height: 1; padding: 0;
}
.chip-x:hover { color: white; }
</style>
</head>
<body class="bg-slate-50 min-h-screen">

<!-- â”€â”€â”€ HEADER â”€â”€â”€ -->
<header class="bg-white shadow-sm sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
    <div class="flex items-center gap-1">
      <span class="text-2xl font-extrabold text-blue-600">QuÃ©bec</span>
      <span class="text-2xl font-extrabold text-gray-800">en Famille</span>
    </div>
    <nav class="hidden md:flex gap-8 text-sm font-semibold text-gray-500">
      <a href="#" class="text-blue-600">Ã‰vÃ©nements</a>
      <a href="#" class="hover:text-blue-600 transition">Carte</a>
      <a href="#" class="hover:text-blue-600 transition">Favoris</a>
    </nav>
  </div>
</header>

<!-- â”€â”€â”€ HERO + FILTERS â”€â”€â”€ -->
<section class="bg-blue-600 pt-8 pb-10">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <div class="flex flex-wrap items-center justify-between gap-4 mb-5">
      <h1 class="text-2xl md:text-3xl font-extrabold text-white">
        ActivitÃ©s Ã  QuÃ©bec
        <span id="heroCount" class="inline-flex items-center justify-center bg-white/25 text-white rounded-full text-sm font-bold min-w-[26px] h-[26px] px-2 ml-2">â€¦</span>
      </h1>
      <input id="filtreTexte" type="text" placeholder="ğŸ”  Rechercherâ€¦"
        class="bg-white/20 text-white placeholder-blue-200 border border-white/30 rounded-full px-4 py-2 text-sm w-52
               focus:outline-none focus:bg-white focus:text-gray-800 focus:placeholder-gray-400 transition">
    </div>

    <!-- Filter bar -->
    <div class="bg-white rounded-2xl shadow-xl px-5 py-4">
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">

        <!-- ThÃ¨me (multi) -->
        <div>
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5">ThÃ¨me</p>
          <div class="dd-wrapper" id="dd-theme">
            <button class="dd-trigger" type="button">
              <span class="dd-label">Tous</span><span class="dd-arrow">â–¼</span>
            </button>
            <div class="dd-panel">
              <div class="dd-opt" data-val="arts">              <span class="dd-chk"></span>ğŸ¨ Arts &amp; Ateliers</div>
              <div class="dd-opt" data-val="cinÃ©ma">            <span class="dd-chk"></span>ğŸ¬ CinÃ©ma</div>
              <div class="dd-opt" data-val="visite guidÃ©e">     <span class="dd-chk"></span>ğŸ› Visites guidÃ©es</div>
              <div class="dd-opt" data-val="musique">           <span class="dd-chk"></span>ğŸµ Musique</div>
              <div class="dd-opt" data-val="Ã©vÃ©nement spÃ©cial"> <span class="dd-chk"></span>â­ Ã‰vÃ©nements spÃ©ciaux</div>
              <div class="dd-opt" data-val="exposition">        <span class="dd-chk"></span>ğŸ–¼ Expositions</div>
              <span class="dd-clear">âœ• Tout effacer</span>
            </div>
          </div>
        </div>

        <!-- Ã‚ge (multi) -->
        <div>
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5">Ã‚ge</p>
          <div class="dd-wrapper" id="dd-age">
            <button class="dd-trigger" type="button">
              <span class="dd-label">Tous</span><span class="dd-arrow">â–¼</span>
            </button>
            <div class="dd-panel">
              <div class="dd-opt" data-val="0-3"> <span class="dd-chk"></span>0â€“3 ans</div>
              <div class="dd-opt" data-val="3-5"> <span class="dd-chk"></span>3â€“5 ans</div>
              <div class="dd-opt" data-val="6-12"><span class="dd-chk"></span>6â€“12 ans</div>
              <div class="dd-opt" data-val="13+"> <span class="dd-chk"></span>13 ans +</div>
              <span class="dd-clear">âœ• Tout effacer</span>
            </div>
          </div>
        </div>

        <!-- PÃ©riode (single) -->
        <div>
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5">PÃ©riode</p>
          <div class="dd-wrapper" id="dd-periode">
            <button class="dd-trigger" type="button">
              <span class="dd-label">Toutes les dates</span><span class="dd-arrow">â–¼</span>
            </button>
            <div class="dd-panel">
              <div class="dd-opt radio-opt selected" data-val="">  <span class="dd-chk"></span>Toutes les dates</div>
              <div class="dd-opt radio-opt" data-val="today">      <span class="dd-chk"></span>Aujourd'hui</div>
              <div class="dd-opt radio-opt" data-val="week">       <span class="dd-chk"></span>Cette semaine</div>
              <div class="dd-opt radio-opt" data-val="month">      <span class="dd-chk"></span>Ce mois</div>
              <div class="dd-opt radio-opt" data-val="nextmonth">  <span class="dd-chk"></span>Mois prochain</div>
            </div>
          </div>
        </div>

        <!-- Quartier (multi + hierarchy) -->
        <div>
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5">Quartier</p>
          <div class="dd-wrapper" id="dd-quartier">
            <button class="dd-trigger" type="button">
              <span class="dd-label">Tous</span><span class="dd-arrow">â–¼</span>
            </button>
            <div class="dd-panel" style="min-width:260px">
              <div class="dd-opt is-child" data-val="Vieux-QuÃ©bec" data-parent="La CitÃ©-Limoilou">
                <span class="dd-chk"></span>Vieux-QuÃ©bec
              </div>
              <div class="dd-opt is-child" data-val="Montcalm" data-parent="La CitÃ©-Limoilou">
                <span class="dd-chk"></span>Montcalm
              </div>
              <div class="dd-opt is-parent" data-val="La CitÃ©-Limoilou" data-children="Vieux-QuÃ©bec,Montcalm">
                <span class="dd-chk"></span>
                <span>La CitÃ©-Limoilou <span style="font-size:0.72rem;font-weight:400;color:#94a3b8">(inclut â†‘)</span></span>
              </div>
              <div class="dd-divider"></div>
              <div class="dd-opt" data-val="Charlesbourg">            <span class="dd-chk"></span>Charlesbourg</div>
              <div class="dd-opt" data-val="Les RiviÃ¨res">            <span class="dd-chk"></span>Les RiviÃ¨res</div>
              <div class="dd-opt" data-val="Beauport">                <span class="dd-chk"></span>Beauport</div>
              <div class="dd-opt" data-val="La Haute-Saint-Charles">  <span class="dd-chk"></span>La Haute-Saint-Charles</div>
              <div class="dd-opt" data-val="Sainte-Foyâ€“Silleryâ€“Cap-Rouge"><span class="dd-chk"></span>Sainte-Foyâ€“Silleryâ€“Cap-Rouge</div>
              <span class="dd-clear">âœ• Tout effacer</span>
            </div>
          </div>
        </div>

        <!-- Recherche (col 5, desktop) -->
        <div class="hidden lg:block">
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5">Recherche</p>
          <input id="filtreTexteInline" type="text" placeholder="Mot-clÃ©â€¦"
            class="w-full px-3 py-2 text-sm font-medium border-2 border-slate-200 rounded-xl bg-slate-50 text-gray-600
                   focus:outline-none focus:border-blue-400 transition placeholder-slate-400">
        </div>

      </div>
    </div>

    <!-- Active filter chips -->
    <div id="summaryBar" class="mt-3 hidden flex-wrap items-center gap-2">
      <span class="text-xs font-bold text-blue-200 uppercase tracking-wider">Filtres :</span>
      <div id="summaryChips" class="flex flex-wrap gap-2"></div>
      <button onclick="clearAll()" class="ml-auto text-xs text-blue-300 hover:text-white font-semibold">Tout effacer</button>
    </div>

  </div>
</section>

<!-- â”€â”€â”€ EVENT GRID â”€â”€â”€ -->
<main class="max-w-7xl mx-auto px-4 py-8">
  <div id="eventGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <p class="text-center col-span-full text-gray-400">Chargement des activitÃ©sâ€¦</p>
  </div>
</main>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DROPDOWN COMPONENT
// mode: 'multi' | 'single'
// onChange(Set | string)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window._ddList = [];

function Dropdown(wrapperId, mode, onChange) {
  const wrap     = document.getElementById(wrapperId);
  const trigger  = wrap.querySelector('.dd-trigger');
  const panel    = wrap.querySelector('.dd-panel');
  const labelEl  = trigger.querySelector('.dd-label');
  const opts     = [...panel.querySelectorAll('.dd-opt')];
  const clearBtn = panel.querySelector('.dd-clear');
  let selected   = new Set();

  window._ddList.push({ panel, trigger });

  trigger.addEventListener('click', e => {
    e.stopPropagation();
    const isOpen = panel.classList.contains('open');
    closeAll();
    if (!isOpen) { panel.classList.add('open'); trigger.classList.add('open'); }
  });

  opts.forEach(opt => {
    opt.addEventListener('click', e => {
      e.stopPropagation();
      const val      = opt.dataset.val;
      const children = opt.dataset.children ? opt.dataset.children.split(',') : [];
      const parent   = opt.dataset.parent || null;

      if (mode === 'single') {
        selected.clear();
        if (val) selected.add(val);
        panel.classList.remove('open');
        trigger.classList.remove('open');
      } else {
        if (selected.has(val)) {
          selected.delete(val);
          children.forEach(c => selected.delete(c));
          if (parent) selected.delete(parent);
        } else {
          selected.add(val);
          children.forEach(c => selected.add(c));
          if (parent) {
            const siblings = opts
              .filter(o => o.dataset.parent === parent)
              .map(o => o.dataset.val);
            if (siblings.every(s => selected.has(s))) selected.add(parent);
          }
        }
      }
      refresh();
      onChange(mode === 'single' ? (selected.size ? [...selected][0] : '') : new Set(selected));
    });
  });

  if (clearBtn) {
    clearBtn.addEventListener('click', e => {
      e.stopPropagation();
      selected.clear();
      refresh();
      onChange(mode === 'single' ? '' : new Set());
    });
  }

  function refresh() {
    opts.forEach(opt => {
      const val      = opt.dataset.val;
      const children = opt.dataset.children ? opt.dataset.children.split(',') : [];
      const isSel    = selected.has(val) || (mode === 'single' && val === '' && selected.size === 0);
      const someKid  = children.some(c => selected.has(c));
      opt.classList.toggle('selected', isSel || someKid);
    });

    if (selected.size === 0) {
      const def = mode === 'single'
        ? (opts.find(o => o.dataset.val === '') || opts[0])
        : null;
      labelEl.textContent = def ? def.textContent.trim() : 'Tous';
      trigger.classList.remove('has-value');
      const b = trigger.querySelector('.dd-badge');
      if (b) b.remove();
    } else {
      const first = opts.find(o => selected.has(o.dataset.val));
      labelEl.textContent = first ? first.textContent.trim() : '';
      trigger.classList.add('has-value');
      if (mode === 'multi') {
        let badge = trigger.querySelector('.dd-badge');
        if (selected.size > 1) {
          if (!badge) { badge = document.createElement('span'); badge.className = 'dd-badge'; trigger.insertBefore(badge, trigger.querySelector('.dd-arrow')); }
          badge.textContent = selected.size;
        } else {
          if (badge) badge.remove();
        }
      }
    }
  }

  this.reset = () => { selected.clear(); refresh(); onChange(mode === 'single' ? '' : new Set()); };
  refresh();
}

function closeAll() {
  window._ddList.forEach(({ panel, trigger }) => {
    panel.classList.remove('open');
    trigger.classList.remove('open');
  });
}
document.addEventListener('click', closeAll);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MOIS_FR = {
  'janvier':1,'fÃ©vrier':2,'mars':3,'avril':4,'mai':5,'juin':6,
  'juillet':7,'aoÃ»t':8,'septembre':9,'octobre':10,'novembre':11,'dÃ©cembre':12
};

function parseDateFR(str) {
  if (!str) return null;
  const m = str.toLowerCase().match(/(\d{1,2})\s+(\w+)\s+(\d{4})/);
  if (!m) return null;
  const month = MOIS_FR[m[2]];
  if (!month) return null;
  return new Date(parseInt(m[3]), month - 1, parseInt(m[1]));
}

function parsePlage(dateStr) {
  if (!dateStr) return { debut: null, fin: null };
  const m = dateStr.match(/(.+?)\s+au\s+(.+)/i);
  if (m) return { debut: parseDateFR(m[1]), fin: parseDateFR(m[2]) };
  const d = parseDateFR(dateStr);
  return { debut: d, fin: d };
}

function debutSemaine(d) {
  const j = new Date(d); j.setDate(j.getDate() - j.getDay()); j.setHours(0,0,0,0); return j;
}
function finSemaine(d) {
  const j = debutSemaine(d); j.setDate(j.getDate() + 6); j.setHours(23,59,59,999); return j;
}
function chevaucheFenetre(plage, debut, fin) {
  if (!plage.debut || !plage.fin) return true;
  return plage.debut <= fin && plage.fin >= debut;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME â†’ CSS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function themeCSS(t) {
  t = (t||'').toLowerCase();
  if (t.includes('art')||t.includes('atel'))   return ['tc-arts',   'bc-arts'];
  if (t.includes('cin'))                        return ['tc-cinema', 'bc-cinema'];
  if (t.includes('visit')||t.includes('guid'))  return ['tc-visite', 'bc-visite'];
  if (t.includes('musiqu')||t.includes('conc')) return ['tc-musique','bc-musique'];
  if (t.includes('nement')||t.includes('spÃ©c')) return ['tc-event',  'bc-event'];
  if (t.includes('expo'))                       return ['tc-expo',   'bc-expo'];
  return ['tc-arts','bc-arts'];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARD RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function afficherCartes(liste) {
  document.getElementById('heroCount').textContent = liste.length;
  const grid = document.getElementById('eventGrid');
  if (!liste.length) {
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:60px 20px;color:#94a3b8">
      <div style="font-size:3rem;margin-bottom:12px">ğŸ”</div>
      <p style="font-weight:700;font-size:1.1rem">Aucune activitÃ© trouvÃ©e</p>
      <p style="font-size:0.85rem;margin-top:4px">Essayez d'Ã©largir vos filtres</p></div>`;
    return;
  }
  grid.innerHTML = liste.map(ev => {
    const [lbl, bdg] = themeCSS(ev.theme);
    const badge = ev.date ? `<span class="date-badge ${bdg}">${ev.date}</span>` : '';
    return `<a href="${ev.URL||'#'}" target="_blank" rel="noopener noreferrer" class="event-card">
      <div style="position:relative">
        <img src="${ev.image||'https://via.placeholder.com/600x300'}"
             style="width:100%;height:192px;object-fit:cover" alt="${ev.titre}" loading="lazy">
        ${badge}
      </div>
      <div style="padding:20px">
        <span class="text-xs font-bold uppercase tracking-wider ${lbl}">${ev.theme||''}</span>
        <h3 style="font-size:1.1rem;font-weight:700;color:#111827;margin:4px 0 6px">${ev.titre}</h3>
        <p style="font-size:0.83rem;color:#6b7280">ğŸ“ ${ev.lieu}</p>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px">
          <span style="font-size:0.82rem;color:#6b7280">Ã‚ge : ${ev.age}</span>
          <span style="font-size:0.75rem;font-weight:700;background:#dcfce7;color:#15803d;padding:3px 10px;border-radius:999px">${ev.prix}</span>
        </div>
      </div>
    </a>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tousLesEvenements = [];
let fThemes    = new Set();
let fAges      = new Set();
let fPeriode   = '';
let fQuartiers = new Set();
let fTexte     = '';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function norm(s) { return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }

function filtrer() {
  const now   = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  let fD = null, fF = null;

  if (fPeriode === 'today') {
    fD = today; fF = new Date(today); fF.setHours(23,59,59,999);
  } else if (fPeriode === 'week') {
    fD = debutSemaine(today); fF = finSemaine(today);
  } else if (fPeriode === 'month') {
    fD = new Date(now.getFullYear(), now.getMonth(), 1);
    fF = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
  } else if (fPeriode === 'nextmonth') {
    fD = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    fF = new Date(now.getFullYear(), now.getMonth() + 2, 0, 23, 59, 59);
  }

  const result = tousLesEvenements.filter(ev => {
    // ThÃ¨me â€” OR
    if (fThemes.size > 0) {
      if (![...fThemes].some(t => norm(ev.theme).includes(norm(t)))) return false;
    }
    // Ã‚ge â€” OR
    if (fAges.size > 0) {
      const a = norm(ev.age);
      if (a !== 'tous') {
        const n = parseInt((a.match(/\d+/)||['99'])[0]);
        const ok = [...fAges].some(range => {
          if (range === '0-3')  return n <= 3;
          if (range === '3-5')  return n >= 3 && n <= 6;
          if (range === '6-12') return n >= 5 && n <= 12;
          if (range === '13+')  return n >= 12;
          return false;
        });
        if (!ok) return false;
      }
    }
    // PÃ©riode
    if (fD && fF) {
      const plage = parsePlage(ev.date || '');
      if (!chevaucheFenetre(plage, fD, fF)) return false;
    }
    // Quartier â€” OR
    if (fQuartiers.size > 0) {
      if (![...fQuartiers].some(q => norm(q) === norm(ev.quartier))) return false;
    }
    // Texte
    if (fTexte) {
      if (!norm((ev.titre||'') + ' ' + (ev.description||'')).includes(fTexte)) return false;
    }
    return true;
  });

  afficherCartes(result);
  updateSummary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIVE FILTER SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const THEME_LBL  = { 'arts':'ğŸ¨ Arts','cinÃ©ma':'ğŸ¬ CinÃ©ma','visite guidÃ©e':'ğŸ› Visites','musique':'ğŸµ Musique','Ã©vÃ©nement spÃ©cial':'â­ Ã‰vÃ©nements','exposition':'ğŸ–¼ Expos' };
const AGE_LBL    = { '0-3':'0â€“3 ans','3-5':'3â€“5 ans','6-12':'6â€“12 ans','13+':'13 ans +' };
const PERIOD_LBL = { 'today':"Aujourd'hui",'week':'Cette semaine','month':'Ce mois','nextmonth':'Mois prochain' };

function updateSummary() {
  const bar   = document.getElementById('summaryBar');
  const chips = document.getElementById('summaryChips');
  const tags  = [];

  fThemes.forEach(v    => tags.push({ label: THEME_LBL[v]||v,            rm: () => { fThemes.delete(v);    ddTheme.reset();    filtrer(); } }));
  fAges.forEach(v      => tags.push({ label: AGE_LBL[v]||v,              rm: () => { fAges.delete(v);      ddAge.reset();      filtrer(); } }));
  if (fPeriode)          tags.push({ label: PERIOD_LBL[fPeriode]||fPeriode, rm: () => { fPeriode=''; ddPeriode.reset(); filtrer(); } });
  fQuartiers.forEach(v => tags.push({ label: v,                           rm: () => { fQuartiers.delete(v); ddQuartier.reset(); filtrer(); } }));
  if (fTexte)            tags.push({ label: `"${fTexte}"`,                rm: () => { fTexte=''; syncTexte(''); filtrer(); } });

  if (!tags.length) { bar.classList.add('hidden'); bar.classList.remove('flex'); return; }
  bar.classList.remove('hidden'); bar.classList.add('flex');
  chips.innerHTML = tags.map((t, i) =>
    `<span class="chip">${t.label}<button class="chip-x" data-i="${i}">âœ•</button></span>`
  ).join('');
  chips.querySelectorAll('.chip-x').forEach(b =>
    b.addEventListener('click', () => { tags[+b.dataset.i].rm(); })
  );
}

function syncTexte(val) {
  document.getElementById('filtreTexte').value = val;
  document.getElementById('filtreTexteInline').value = val;
}

function clearAll() {
  fThemes.clear(); fAges.clear(); fPeriode = ''; fQuartiers.clear(); fTexte = '';
  ddTheme.reset(); ddAge.reset(); ddPeriode.reset(); ddQuartier.reset();
  syncTexte('');
  filtrer();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT DROPDOWNS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ddTheme    = new Dropdown('dd-theme',    'multi',  sel => { fThemes    = sel; filtrer(); });
const ddAge      = new Dropdown('dd-age',      'multi',  sel => { fAges      = sel; filtrer(); });
const ddPeriode  = new Dropdown('dd-periode',  'single', val => { fPeriode   = val; filtrer(); });
const ddQuartier = new Dropdown('dd-quartier', 'multi',  sel => { fQuartiers = sel; filtrer(); });

// Search inputs (header + inline) stay in sync
function onSearch(v) { fTexte = norm(v); filtrer(); }
document.getElementById('filtreTexte').addEventListener('input', e => {
  document.getElementById('filtreTexteInline').value = e.target.value;
  onSearch(e.target.value);
});
document.getElementById('filtreTexteInline').addEventListener('input', e => {
  document.getElementById('filtreTexte').value = e.target.value;
  onSearch(e.target.value);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function chargerDonnees() {
  try {
    const reponse = await fetch('./evenements.json');
    if (!reponse.ok) throw new Error('Fichier introuvable (404)');
    tousLesEvenements = await reponse.json();
    afficherCartes(tousLesEvenements);
  } catch (err) {
    document.getElementById('eventGrid').innerHTML =
      `<p class="text-center col-span-full text-red-400">Erreur : ${err.message}</p>`;
  }
}

document.addEventListener('DOMContentLoaded', chargerDonnees);
</script>
</body>
</html>
