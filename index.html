<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QuÃ©bec en Famille - AgrÃ©gateur d'activitÃ©s</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
* { font-family: 'Outfit', sans-serif; box-sizing: border-box; }

/* â”€â”€ Dropdown trigger â”€â”€ */
.dd-trigger {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 14px; border-radius: 10px;
  font-size: 0.82rem; font-weight: 600; cursor: pointer;
  border: 2px solid #e2e8f0; background: #f8fafc; color: #475569;
  transition: all 0.15s; white-space: nowrap; user-select: none;
  width: 100%;
}
.dd-trigger:hover { border-color: #cbd5e1; background: #f1f5f9; }
.dd-trigger.has-value { border-color: #1d4ed8; background: #eff6ff; color: #1d4ed8; }
.dd-trigger.open { border-color: #3b82f6; }
.dd-arrow { margin-left: auto; font-size: 0.7rem; opacity: 0.4; transition: transform 0.2s; }
.dd-trigger.open .dd-arrow { transform: rotate(180deg); opacity: 0.7; }
.dd-badge {
  background: #1d4ed8; color: white; border-radius: 999px;
  font-size: 0.68rem; font-weight: 800; padding: 1px 7px;
}

/* â”€â”€ Dropdown panel â”€â”€ */
.dd-wrapper { position: relative; }
.dd-panel {
  display: none; position: absolute; top: calc(100% + 6px); left: 0;
  background: white; border: 1.5px solid #e2e8f0; border-radius: 12px;
  box-shadow: 0 10px 32px rgba(0,0,0,0.13);
  z-index: 500; min-width: 220px; overflow: hidden;
}
.dd-panel.open { display: block; }

/* â”€â”€ Option items â”€â”€ */
.dd-opt {
  display: flex; align-items: center; gap: 9px;
  padding: 9px 14px; font-size: 0.83rem; font-weight: 500;
  color: #374151; cursor: pointer; transition: background 0.1s;
}
.dd-opt:hover { background: #f0f7ff; }
.dd-opt.selected { background: #dbeafe; color: #1d4ed8; font-weight: 700; }
.dd-opt.is-parent { font-weight: 700; border-top: 1px solid #f3f4f6; }
.dd-opt.is-parent:first-child { border-top: none; }
.dd-opt.is-child { padding-left: 28px; font-size: 0.8rem; color: #4b5563; }
.dd-opt.is-child.selected { color: #1d4ed8; }

/* Checkbox */
.dd-chk {
  width: 16px; height: 16px; min-width: 16px;
  border: 2px solid #d1d5db; border-radius: 4px; background: white;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.12s; flex-shrink: 0;
}
.dd-opt.selected .dd-chk { background: #1d4ed8; border-color: #1d4ed8; }
.dd-opt.selected .dd-chk::after {
  content: ''; display: block; width: 8px; height: 4px;
  border-left: 2px solid white; border-bottom: 2px solid white;
  transform: rotate(-45deg) translateY(-1px);
}
/* Radio style for PÃ©riode */
.dd-opt.radio-opt .dd-chk { border-radius: 999px; }
.dd-opt.radio-opt.selected .dd-chk::after {
  width: 6px; height: 6px; border: none;
  background: white; border-radius: 999px; transform: none;
}

/* Divider + clear inside panel */
.dd-divider { height: 1px; background: #f1f5f9; margin: 4px 0; }
.dd-clear {
  display: block; padding: 8px 14px; font-size: 0.75rem;
  color: #94a3b8; cursor: pointer; text-align: center;
  border-top: 1px solid #f1f5f9; transition: color 0.1s;
}
.dd-clear:hover { color: #ef4444; }

/* â”€â”€ Cards â”€â”€ */
.event-card {
  background: white; border-radius: 16px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.07);
  border: 1px solid #f1f5f9;
  transition: transform 0.18s, box-shadow 0.18s;
  display: flex; flex-direction: column;   /* full-height flex container */
}
.event-card > a {
  display: flex; flex-direction: column; flex: 1;
  text-decoration: none; color: inherit;
}
.event-card-img { overflow: hidden; border-radius: 16px 16px 0 0; flex-shrink: 0; }
.event-card:hover { transform: translateY(-4px); box-shadow: 0 10px 28px rgba(0,0,0,0.13); }

/* Card body â€” grows to fill space, footer pinned to bottom */
.card-body {
  display: flex; flex-direction: column; flex: 1;
  padding: 16px 20px 18px;
}
.card-body .card-theme {
  font-size: 0.72rem; font-weight: 800; text-transform: uppercase;
  letter-spacing: 0.08em;
}
.card-body .card-title {
  font-size: 1.05rem; font-weight: 700; color: #111827;
  margin: 5px 0 0;
  /* clamp to 2 lines so all cards have equal title height */
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden; line-height: 1.35; min-height: 2.7em;
}
.card-body .card-location {
  font-size: 0.8rem; color: #6b7280; margin-top: 6px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
/* Spacer pushes footer to bottom */
.card-body .card-spacer { flex: 1; }
.card-body .card-footer {
  display: flex; justify-content: space-between; align-items: center;
  margin-top: 14px; padding-top: 12px;
  border-top: 1px solid #f1f5f9;
}
.card-body .card-age  { font-size: 0.79rem; color: #6b7280; }
.card-body .card-prix {
  font-size: 0.72rem; font-weight: 700;
  background: #dcfce7; color: #15803d;
  padding: 3px 10px; border-radius: 999px;
  white-space: nowrap; max-width: 120px;
  overflow: hidden; text-overflow: ellipsis;
}

.date-badge {
  position: absolute; top: 10px; right: 10px;
  padding: 4px 10px; border-radius: 6px;
  font-size: 0.66rem; font-weight: 700;
  line-height: 1.5; color: white;
  background: rgba(0,0,0,0.38);
  backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
  text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

/* Theme colours (badge is now neutral transparent â€” theme used for labels only) */
.tc-arts      { color: #2563eb; } .bc-arts    {}
.tc-cinema    { color: #7c3aed; } .bc-cinema  {}
.tc-visite    { color: #0891b2; } .bc-visite  {}
.tc-musique   { color: #db2777; } .bc-musique {}
.tc-event     { color: #d97706; } .bc-event   {}
.tc-expo      { color: #059669; } .bc-expo    {}
.tc-spectacle { color: #9333ea; } .bc-spectacle {}

/* â”€â”€ Sport â”€â”€ */
.tc-sport { color: #ea580c; }
.chip {
  display: inline-flex; align-items: center; gap: 5px;
  background: rgba(255,255,255,0.2); border-radius: 999px;
  padding: 3px 10px; font-size: 0.78rem; font-weight: 600; color: white;
}
.chip-x {
  background: none; border: none; cursor: pointer;
  color: rgba(255,255,255,0.6); font-size: 0.9rem; line-height: 1; padding: 0;
}
.chip-x:hover { color: white; }

/* â”€â”€ Sport â”€â”€ */
.tc-sport { color: #ea580c; }

/* â”€â”€ Bookmark button â”€â”€ */
.btn-bookmark {
  position: absolute; top: 10px; left: 10px; z-index: 2;
  width: 34px; height: 34px; border-radius: 50%;
  background: rgba(0,0,0,0.38);
  backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
  border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem; line-height: 1;
  transition: transform 0.15s, background 0.15s;
}
.btn-bookmark:hover { transform: scale(1.18); background: rgba(0,0,0,0.55); }
.btn-bookmark.saved { background: rgba(0,0,0,0.38); }
.btn-bookmark .star { color: white; font-size: 1.1rem; line-height: 1; transition: color 0.15s; }
.btn-bookmark.saved .star { color: #fbbf24; }

/* â”€â”€ Tab nav â”€â”€ */
.tab-link {
  padding: 4px 0;
  border-bottom: 2px solid transparent;
  transition: color 0.15s, border-color 0.15s;
  cursor: pointer; user-select: none;
}
.tab-link.active             { color: #2563eb; border-color: #2563eb; }
.tab-link:not(.active)       { color: #6b7280; }
.tab-link:not(.active):hover { color: #374151; }

/* â”€â”€ Fav counter badge â”€â”€ */
.fav-badge {
  display: inline-flex; align-items: center; justify-content: center;
  background: #ef4444; color: white; border-radius: 999px;
  font-size: 0.6rem; font-weight: 800;
  min-width: 16px; height: 16px; padding: 0 4px;
  margin-left: 4px; line-height: 1;
  transition: opacity 0.2s;
}

/* â”€â”€ Wee-QenF hero â”€â”€ */
.wee-hero {
  background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 55%, #2563eb 100%);
  padding: 28px 0 28px;
}

/* Meteo cards â€” rebuilt for 4-phase layout */
.meteo-row { display: flex; gap: 16px; margin-top: 20px; flex-wrap: wrap; }
.meteo-card {
  flex: 1; min-width: 260px;
  background: rgba(255,255,255,0.14);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.22);
  border-radius: 20px; padding: 20px 24px; color: white;
}
.meteo-card .mc-day   { font-size: 0.68rem; font-weight: 800; letter-spacing: 0.12em; text-transform: uppercase; opacity: 0.7; }
.meteo-card .mc-date  { font-size: 0.85rem; font-weight: 600; opacity: 0.8; margin-top: 2px; }
.meteo-card .mc-top   { display: flex; align-items: center; gap: 16px; margin: 14px 0 12px; }
.meteo-card .mc-icon  { font-size: 3rem; line-height: 1; }
.meteo-card .mc-main  { display: flex; flex-direction: column; }
.meteo-card .mc-temp  { font-size: 2rem; font-weight: 800; letter-spacing: -0.03em; line-height: 1; }
.meteo-card .mc-temp-f { font-size: 0.78rem; font-weight: 600; opacity: 0.65; margin-top: 3px; }
.meteo-card .mc-cond  { font-size: 0.83rem; font-weight: 600; opacity: 0.85; margin-top: 2px; }
.meteo-card .mc-extra {
  margin-top: 12px; font-size: 0.74rem; font-weight: 600;
  background: rgba(0,0,0,0.2); border-radius: 999px;
  padding: 4px 12px; display: inline-block;
}

/* 4-phase timeline */
.mc-phases {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 4px; margin-top: 14px;
  border-top: 1px solid rgba(255,255,255,0.15);
  padding-top: 14px;
}
.mc-phase {
  display: flex; flex-direction: column; align-items: center;
  gap: 3px; text-align: center;
}
.mc-phase .ph-label {
  font-size: 0.58rem; font-weight: 800; letter-spacing: 0.08em;
  text-transform: uppercase; opacity: 0.55;
}
.mc-phase .ph-icon  { font-size: 1.15rem; line-height: 1; }
.mc-phase .ph-temp  { font-size: 0.78rem; font-weight: 700; }
.mc-phase .ph-temp-f { font-size: 0.62rem; opacity: 0.55; }

/* Wee section day dividers */
.wee-day-label {
  font-size: 1rem; font-weight: 800; color: #1e293b;
  margin: 32px 0 16px; display: flex; align-items: center; gap: 10px;
}
.wee-day-label::after {
  content: ''; flex: 1; height: 2px; background: #e2e8f0; border-radius: 2px;
}

/* â”€â”€ Day toggle buttons â”€â”€ */
.wee-day-toggle {
  display: flex; gap: 10px; margin-bottom: 8px;
}
.wee-day-btn {
  padding: 8px 22px; border-radius: 10px; font-size: 0.88rem; font-weight: 700;
  border: 2px solid #e2e8f0; background: white; color: #475569;
  cursor: pointer; transition: all 0.15s; user-select: none;
}
.wee-day-btn:hover { border-color: #93c5fd; color: #1d4ed8; background: #eff6ff; }
.wee-day-btn.active {
  background: #2563eb; border-color: #2563eb; color: white;
}

/* â”€â”€ Notre sÃ©lection accordion â”€â”€ */
.wee-selection-bar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 22px; border-radius: 14px;
  background: linear-gradient(135deg, #14532d, #16a34a);
  color: white; cursor: pointer; user-select: none;
  transition: box-shadow 0.15s; margin-bottom: 0;
}
.wee-selection-bar:hover { box-shadow: 0 6px 20px rgba(22,163,74,0.40); }
.wee-selection-bar .sel-title {
  font-size: 1rem; font-weight: 800; letter-spacing: -0.01em;
}
.wee-selection-bar .sel-sub {
  font-size: 0.78rem; font-weight: 500; opacity: 0.75; margin-top: 2px;
}
.wee-selection-bar .sel-arrow {
  font-size: 1.1rem; transition: transform 0.25s; flex-shrink: 0;
}
.wee-selection-bar.open .sel-arrow { transform: rotate(180deg); }

.wee-selection-body {
  display: none; padding-top: 20px;
}
.wee-selection-body.open { display: block; }

/* â”€â”€ Wide selection card â”€â”€ */
.sel-card {
  display: flex; background: white; border-radius: 16px;
  box-shadow: 0 2px 14px rgba(0,0,0,0.07); border: 1px solid #f1f5f9;
  overflow: hidden; transition: transform 0.18s, box-shadow 0.18s;
  text-decoration: none; color: inherit; margin-bottom: 14px;
  position: relative;
}
.sel-card:last-child { margin-bottom: 0; }
.sel-card:hover { transform: translateY(-3px); box-shadow: 0 8px 28px rgba(0,0,0,0.12); }
.sel-card-img {
  width: 200px; min-width: 200px; flex-shrink: 0; position: relative; overflow: hidden;
}
.sel-card-img img {
  width: 100%; height: 100%; object-fit: cover; display: block;
}
.sel-card-img .sel-rank {
  position: absolute; top: 10px; left: 10px;
  background: #2563eb; color: white; border-radius: 50%;
  width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
  font-size: 0.75rem; font-weight: 800;
}
.sel-card-img .date-badge { font-size: 0.62rem; }
.sel-card-body {
  display: flex; flex-direction: column; flex: 1; padding: 18px 22px;
}
.sel-card-body .sel-theme {
  font-size: 0.68rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.08em;
}
.sel-card-body .sel-title {
  font-size: 1.1rem; font-weight: 800; color: #111827; margin: 4px 0 6px; line-height: 1.3;
}
.sel-card-body .sel-summary {
  font-size: 0.83rem; color: #374151; line-height: 1.5; flex: 1;
}
.sel-card-body .sel-meta {
  display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; align-items: center;
}
.sel-card-body .sel-meta-item {
  font-size: 0.75rem; color: #6b7280; display: flex; align-items: center; gap: 4px;
}
.sel-card-body .sel-prix {
  font-size: 0.72rem; font-weight: 700;
  background: #dcfce7; color: #15803d; padding: 3px 10px; border-radius: 999px;
  margin-left: auto;
}
.sel-card-body .sel-why {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em;
  background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 999px;
}
.sel-card .btn-bookmark {
  top: 10px; left: unset; right: 10px; /* move bookmark to top-right on wide card */
}
/* Mobile: stack wide card vertically */
@media (max-width: 640px) {
  .sel-card { flex-direction: column; }
  .sel-card-img { width: 100%; min-width: unset; height: 180px; }
}
</style>
</head>
<body class="bg-slate-50 min-h-screen">

<!-- â”€â”€â”€ HEADER â”€â”€â”€ -->
<header class="bg-white shadow-sm sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
    <div class="flex items-center gap-1" onclick="setTab('events')" style="cursor:pointer">
      <span class="text-2xl font-extrabold text-blue-600">QuÃ©bec</span>
      <span class="text-2xl font-extrabold text-gray-800">en Famille</span>
    </div>
    <nav class="hidden md:flex gap-8 text-sm font-semibold">
      <span class="tab-link active" id="tab-events"  onclick="setTab('events')">Ã‰vÃ©nements</span>
      <span class="tab-link"        id="tab-wee"     onclick="setTab('wee')">Wee-QenF!</span>
      <span class="tab-link"        id="tab-favoris" onclick="setTab('favoris')">
        Favoris<span class="fav-badge" id="favBadge" style="opacity:0">0</span>
      </span>
    </nav>
  </div>
</header>

<!-- â”€â”€â”€ HERO + FILTERS â”€â”€â”€ -->
<section class="bg-blue-600 pt-8 pb-10">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <div class="flex flex-wrap items-center justify-between gap-4 mb-5">
      <h1 class="text-2xl md:text-3xl font-extrabold text-white">
        ActivitÃ©s Ã  QuÃ©bec
        <span id="heroCount" class="inline-flex items-center justify-center bg-white/25 text-white rounded-full text-sm font-bold min-w-[26px] h-[26px] px-2 ml-2">â€¦</span>
      </h1>
      <input id="filtreTexte" type="text" placeholder="Rechercherâ€¦"
        class="bg-white/20 text-white placeholder-blue-200 border border-white/30 rounded-full px-4 py-2 text-sm w-52
               focus:outline-none focus:bg-white focus:text-gray-800 focus:placeholder-gray-400 transition">
    </div>

    <!-- Filter bar -->
    <div class="bg-white rounded-2xl shadow-xl px-5 py-4">
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">

        <!-- ThÃ¨me (multi) -->
        <div>
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5">ThÃ¨me</p>
          <div class="dd-wrapper" id="dd-theme">
            <button class="dd-trigger" type="button">
              <span class="dd-label">Tous</span><span class="dd-arrow">â–¼</span>
            </button>
            <div class="dd-panel">
              <div class="dd-opt" data-val="arts">              <span class="dd-chk"></span>ğŸ¨ Arts &amp; Ateliers</div>
              <div class="dd-opt" data-val="cinÃ©ma">            <span class="dd-chk"></span>ğŸ¬ CinÃ©ma</div>
              <div class="dd-opt" data-val="visite guidÃ©e">     <span class="dd-chk"></span>ğŸ› Visites guidÃ©es</div>
              <div class="dd-opt" data-val="musique">           <span class="dd-chk"></span>ğŸµ Musique</div>
              <div class="dd-opt" data-val="spectacle">         <span class="dd-chk"></span>ğŸ­ Spectacles</div>
              <div class="dd-opt" data-val="Ã©vÃ©nement spÃ©cial"> <span class="dd-chk"></span>â­ Ã‰vÃ©nements spÃ©ciaux</div>
              <div class="dd-opt" data-val="exposition">        <span class="dd-chk"></span>ğŸ–¼ Expositions</div>
              <div class="dd-opt" data-val="sport">             <span class="dd-chk"></span>âš½ Sport</div>
              <span class="dd-clear">âœ• Tout effacer</span>
            </div>
          </div>
        </div>

        <!-- Ã‚ge (multi) -->
        <div>
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5">Ã‚ge</p>
          <div class="dd-wrapper" id="dd-age">
            <button class="dd-trigger" type="button">
              <span class="dd-label">Tous</span><span class="dd-arrow">â–¼</span>
            </button>
            <div class="dd-panel">
              <div class="dd-opt" data-val="0-3"> <span class="dd-chk"></span>0â€“3 ans</div>
              <div class="dd-opt" data-val="3-5"> <span class="dd-chk"></span>3â€“5 ans</div>
              <div class="dd-opt" data-val="6-12"><span class="dd-chk"></span>6â€“12 ans</div>
              <div class="dd-opt" data-val="13+"> <span class="dd-chk"></span>13 ans +</div>
              <span class="dd-clear">âœ• Tout effacer</span>
            </div>
          </div>
        </div>

        <!-- PÃ©riode (single) -->
        <div>
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5">PÃ©riode</p>
          <div class="dd-wrapper" id="dd-periode">
            <button class="dd-trigger" type="button">
              <span class="dd-label">Toutes les dates</span><span class="dd-arrow">â–¼</span>
            </button>
            <div class="dd-panel">
              <div class="dd-opt radio-opt selected" data-val="">  <span class="dd-chk"></span>Toutes les dates</div>
              <div class="dd-opt radio-opt" data-val="today">      <span class="dd-chk"></span>Aujourd'hui</div>
              <div class="dd-opt radio-opt" data-val="week">       <span class="dd-chk"></span>Cette semaine</div>
              <div class="dd-opt radio-opt" data-val="month">      <span class="dd-chk"></span>Ce mois</div>
              <div class="dd-opt radio-opt" data-val="nextmonth">  <span class="dd-chk"></span>Mois prochain</div>
            </div>
          </div>
        </div>

        <!-- Quartier (multi + hierarchy) -->
        <div>
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5">Quartier</p>
          <div class="dd-wrapper" id="dd-quartier">
            <button class="dd-trigger" type="button">
              <span class="dd-label">Tous</span><span class="dd-arrow">â–¼</span>
            </button>
            <div class="dd-panel" style="min-width:260px">
              <div class="dd-opt is-child" data-val="Vieux-QuÃ©bec" data-parent="La CitÃ©-Limoilou">
                <span class="dd-chk"></span>Vieux-QuÃ©bec
              </div>
              <div class="dd-opt is-child" data-val="Montcalm" data-parent="La CitÃ©-Limoilou">
                <span class="dd-chk"></span>Montcalm
              </div>
              <div class="dd-opt is-parent" data-val="La CitÃ©-Limoilou" data-children="Vieux-QuÃ©bec,Montcalm">
                <span class="dd-chk"></span>
                <span>La CitÃ©-Limoilou <span style="font-size:0.72rem;font-weight:400;color:#94a3b8">(inclut â†‘)</span></span>
              </div>
              <div class="dd-divider"></div>
              <div class="dd-opt" data-val="Charlesbourg">            <span class="dd-chk"></span>Charlesbourg</div>
              <div class="dd-opt" data-val="Les RiviÃ¨res">            <span class="dd-chk"></span>Les RiviÃ¨res</div>
              <div class="dd-opt" data-val="Beauport">                <span class="dd-chk"></span>Beauport</div>
              <div class="dd-opt" data-val="La Haute-Saint-Charles">  <span class="dd-chk"></span>La Haute-Saint-Charles</div>
              <div class="dd-opt" data-val="Sainte-Foyâ€“Silleryâ€“Cap-Rouge"><span class="dd-chk"></span>Sainte-Foyâ€“Silleryâ€“Cap-Rouge</div>
              <div class="dd-divider"></div>
              <div class="dd-opt" data-val="Wendake">                 <span class="dd-chk"></span>Wendake</div>
              <div class="dd-opt" data-val="Petite-Lorette">          <span class="dd-chk"></span>Petite-Lorette</div>
              <div class="dd-divider"></div>
              <div class="dd-opt" data-val="LÃ©vis">                   <span class="dd-chk"></span>LÃ©vis</div>
              <span class="dd-clear">âœ• Tout effacer</span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Active filter chips -->
    <div id="summaryBar" class="mt-3 hidden flex-wrap items-center gap-2">
      <span class="text-xs font-bold text-blue-200 uppercase tracking-wider">Filtres :</span>
      <div id="summaryChips" class="flex flex-wrap gap-2"></div>
      <button onclick="clearAll()" class="ml-auto text-xs text-blue-300 hover:text-white font-semibold">Tout effacer</button>
    </div>

  </div>
</section>

<!-- â”€â”€â”€ WEE-QENF HERO â”€â”€â”€ -->
<div id="weeHero" style="display:none" class="wee-hero">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <div class="flex flex-wrap items-center justify-between gap-3 mb-2">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold text-white">Wee-QenF!</h1>
        <p class="text-blue-200 text-base font-semibold mt-1">Profitez de la fin de semaine en famille</p>
        <p id="weeDateRange" class="text-blue-300 text-sm font-medium mt-0.5">Chargementâ€¦</p>
      </div>
      <span id="weeCount" class="bg-white/20 text-white rounded-full text-sm font-bold px-4 py-1">â€¦</span>
    </div>

    <div class="meteo-row" id="meteoRow">

      <!-- Samedi -->
      <div class="meteo-card">
        <div class="mc-day">Samedi</div>
        <div class="mc-date" id="meteoSamDate">â€”</div>
        <div class="mc-top">
          <div class="mc-icon" id="meteoSamIcon">â³</div>
          <div class="mc-main">
            <div class="mc-temp"  id="meteoSamTemp">â€”</div>
            <div class="mc-temp-f" id="meteoSamTempF">â€”</div>
            <div class="mc-cond"  id="meteoSamCond">Chargementâ€¦</div>
          </div>
        </div>
        <div class="mc-extra" id="meteoSamExtra"></div>
        <div class="mc-phases" id="meteoSamPhases">
          <div class="mc-phase"><div class="ph-label">Matin</div><div class="ph-icon">â³</div><div class="ph-temp">â€”</div><div class="ph-temp-f">â€”</div></div>
          <div class="mc-phase"><div class="ph-label">Midi</div><div class="ph-icon">â³</div><div class="ph-temp">â€”</div><div class="ph-temp-f">â€”</div></div>
          <div class="mc-phase"><div class="ph-label">AprÃ¨s-midi</div><div class="ph-icon">â³</div><div class="ph-temp">â€”</div><div class="ph-temp-f">â€”</div></div>
          <div class="mc-phase"><div class="ph-label">Soir</div><div class="ph-icon">â³</div><div class="ph-temp">â€”</div><div class="ph-temp-f">â€”</div></div>
        </div>
      </div>

      <!-- Dimanche -->
      <div class="meteo-card">
        <div class="mc-day">Dimanche</div>
        <div class="mc-date" id="meteoDimDate">â€”</div>
        <div class="mc-top">
          <div class="mc-icon" id="meteoDimIcon">â³</div>
          <div class="mc-main">
            <div class="mc-temp"  id="meteoDimTemp">â€”</div>
            <div class="mc-temp-f" id="meteoDimTempF">â€”</div>
            <div class="mc-cond"  id="meteoDimCond">Chargementâ€¦</div>
          </div>
        </div>
        <div class="mc-extra" id="meteoDimExtra"></div>
        <div class="mc-phases" id="meteoDimPhases">
          <div class="mc-phase"><div class="ph-label">Matin</div><div class="ph-icon">â³</div><div class="ph-temp">â€”</div><div class="ph-temp-f">â€”</div></div>
          <div class="mc-phase"><div class="ph-label">Midi</div><div class="ph-icon">â³</div><div class="ph-temp">â€”</div><div class="ph-temp-f">â€”</div></div>
          <div class="mc-phase"><div class="ph-label">AprÃ¨s-midi</div><div class="ph-icon">â³</div><div class="ph-temp">â€”</div><div class="ph-temp-f">â€”</div></div>
          <div class="mc-phase"><div class="ph-label">Soir</div><div class="ph-icon">â³</div><div class="ph-temp">â€”</div><div class="ph-temp-f">â€”</div></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- â”€â”€â”€ FAVORIS HERO â”€â”€â”€ -->
<div id="favHero" style="display:none" class="bg-blue-600 py-5">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center gap-3">
    <span style="font-size:1.6rem">ğŸ”–</span>
    <h1 class="text-xl font-extrabold text-white">
      Mes favoris
      <span id="favCount" class="inline-flex items-center justify-center bg-white/25 text-white rounded-full text-sm font-bold min-w-[26px] h-[26px] px-2 ml-2">0</span>
    </h1>
  </div>
</div>

<!-- â”€â”€â”€ EVENT GRID â”€â”€â”€ -->
<main class="max-w-7xl mx-auto px-4 py-8">
  <!-- Wee tab content -->
  <div id="weeLabels" style="display:none">
    <!-- Notre sÃ©lection accordion â€” above day toggle -->
    <div style="margin-bottom:16px">
      <div class="wee-selection-bar" id="selBar" onclick="toggleSelection()">
        <div>
          <div class="sel-title">DÃ©couvrez notre sÃ©lection d'activitÃ©s pour la fin de semaine</div>
        </div>
        <span class="sel-arrow">â–¼</span>
      </div>
      <div class="wee-selection-body" id="selBody">
        <div id="selGrid"></div>
      </div>
    </div>

    <!-- Day toggle buttons -->
    <div class="wee-day-toggle" id="weeDayToggle">
      <button class="wee-day-btn active" id="btnSam" onclick="setWeeDay('sam')">Samedi</button>
      <button class="wee-day-btn"        id="btnDim" onclick="setWeeDay('dim')">Dimanche</button>
    </div>

    <!-- Day grid (injected by afficherWee) -->
    <div id="weeDayGrid"></div>
  </div>

  <div id="eventGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <p class="text-center col-span-full text-gray-400">Chargement des activitÃ©sâ€¦</p>
  </div>
</main>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DROPDOWN COMPONENT
// mode: 'multi' | 'single'
// onChange(Set | string)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window._ddList = [];

function Dropdown(wrapperId, mode, onChange) {
  const wrap     = document.getElementById(wrapperId);
  const trigger  = wrap.querySelector('.dd-trigger');
  const panel    = wrap.querySelector('.dd-panel');
  const labelEl  = trigger.querySelector('.dd-label');
  const opts     = [...panel.querySelectorAll('.dd-opt')];
  const clearBtn = panel.querySelector('.dd-clear');
  let selected   = new Set();

  window._ddList.push({ panel, trigger });

  trigger.addEventListener('click', e => {
    e.stopPropagation();
    const isOpen = panel.classList.contains('open');
    closeAll();
    if (!isOpen) { panel.classList.add('open'); trigger.classList.add('open'); }
  });

  opts.forEach(opt => {
    opt.addEventListener('click', e => {
      e.stopPropagation();
      const val      = opt.dataset.val;
      const children = opt.dataset.children ? opt.dataset.children.split(',') : [];
      const parent   = opt.dataset.parent || null;

      if (mode === 'single') {
        selected.clear();
        if (val) selected.add(val);
        panel.classList.remove('open');
        trigger.classList.remove('open');
      } else {
        if (selected.has(val)) {
          selected.delete(val);
          children.forEach(c => selected.delete(c));
          if (parent) selected.delete(parent);
        } else {
          selected.add(val);
          children.forEach(c => selected.add(c));
          if (parent) {
            const siblings = opts
              .filter(o => o.dataset.parent === parent)
              .map(o => o.dataset.val);
            if (siblings.every(s => selected.has(s))) selected.add(parent);
          }
        }
      }
      refresh();
      onChange(mode === 'single' ? (selected.size ? [...selected][0] : '') : new Set(selected));
    });
  });

  if (clearBtn) {
    clearBtn.addEventListener('click', e => {
      e.stopPropagation();
      selected.clear();
      refresh();
      onChange(mode === 'single' ? '' : new Set());
    });
  }

  function refresh() {
    opts.forEach(opt => {
      const val      = opt.dataset.val;
      const children = opt.dataset.children ? opt.dataset.children.split(',') : [];
      const isSel    = selected.has(val) || (mode === 'single' && val === '' && selected.size === 0);
      const someKid  = children.some(c => selected.has(c));
      opt.classList.toggle('selected', isSel || someKid);
    });

    if (selected.size === 0) {
      const def = mode === 'single'
        ? (opts.find(o => o.dataset.val === '') || opts[0])
        : null;
      labelEl.textContent = def ? def.textContent.trim() : 'Tous';
      trigger.classList.remove('has-value');
      const b = trigger.querySelector('.dd-badge');
      if (b) b.remove();
    } else {
      const first = opts.find(o => selected.has(o.dataset.val));
      labelEl.textContent = first ? first.textContent.trim() : '';
      trigger.classList.add('has-value');
      if (mode === 'multi') {
        let badge = trigger.querySelector('.dd-badge');
        if (selected.size > 1) {
          if (!badge) { badge = document.createElement('span'); badge.className = 'dd-badge'; trigger.insertBefore(badge, trigger.querySelector('.dd-arrow')); }
          badge.textContent = selected.size;
        } else {
          if (badge) badge.remove();
        }
      }
    }
  }

  this.reset = () => { selected.clear(); refresh(); onChange(mode === 'single' ? '' : new Set()); };
  refresh();
}

function closeAll() {
  window._ddList.forEach(({ panel, trigger }) => {
    panel.classList.remove('open');
    trigger.classList.remove('open');
  });
}
document.addEventListener('click', closeAll);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME â†’ CSS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function themeCSS(t) {
  t = (t||'').toLowerCase().trim();
  if (t === 'sport'                        ) return ['tc-sport',     'bc-sport'];
  if (t === 'spectacle'                    ) return ['tc-spectacle',  'bc-spectacle'];
  if (t === 'arts' || t.startsWith('art')  ) return ['tc-arts',      'bc-arts'];
  if (t === 'cinÃ©ma' || t.includes('cin')  ) return ['tc-cinema',    'bc-cinema'];
  if (t.includes('visit')||t.includes('guid')) return ['tc-visite',  'bc-visite'];
  if (t.includes('musiqu')||t.includes('conc')) return ['tc-musique','bc-musique'];
  if (t.includes('nement')||t.includes('spÃ©c')) return ['tc-event',  'bc-event'];
  if (t.includes('expo')                   ) return ['tc-expo',      'bc-expo'];
  return ['tc-event','bc-event'];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MOIS_FR = {
  'janvier':1,'fÃ©vrier':2,'mars':3,'avril':4,'mai':5,'juin':6,
  'juillet':7,'aoÃ»t':8,'septembre':9,'octobre':10,'novembre':11,'dÃ©cembre':12
};
const MOIS_NOM = ['janvier','fÃ©vrier','mars','avril','mai','juin',
                  'juillet','aoÃ»t','septembre','octobre','novembre','dÃ©cembre'];

// JS \w is ASCII-only â€” unicode range handles accented months (fÃ©vrier, aoÃ»tâ€¦)
const DATE_RE = /(\d{1,2})\s+([A-Za-z\u00C0-\u024F]+)\s+(\d{4})/;

function parseDateFR(str) {
  if (!str) return null;
  const m = str.toLowerCase().match(DATE_RE);
  if (!m) return null;
  const month = MOIS_FR[m[2]];
  if (!month) return null;
  return new Date(parseInt(m[3]), month - 1, parseInt(m[1]));
}

function parsePlage(dateStr) {
  if (!dateStr) return { debut: null, fin: null };
  // "Jusqu'au â€¦" â€” treat as started long before today
  const jusqu = dateStr.match(/jusqu['\u2019]au\s+(.+)/i);
  if (jusqu) return { debut: new Date(2000, 0, 1), fin: parseDateFR(jusqu[1]) };
  // Collect all full dates, pair first + last
  const allDates = [];
  const re = new RegExp(DATE_RE.source, 'gi');
  let m;
  while ((m = re.exec(dateStr)) !== null) {
    const mo = MOIS_FR[m[2].toLowerCase()];
    if (mo) allDates.push(new Date(parseInt(m[3]), mo - 1, parseInt(m[1])));
  }
  if (allDates.length >= 2) return { debut: allDates[0], fin: allDates[allDates.length - 1] };
  if (allDates.length === 1) return { debut: allDates[0], fin: allDates[0] };
  return { debut: null, fin: null };
}

function dateISO(d) { return d.toISOString().slice(0, 10); }

function formatDateFR(d) {
  return `${d.getDate()} ${MOIS_NOM[d.getMonth()]} ${d.getFullYear()}`;
}

function debutSemaine(d) {
  const j = new Date(d);
  const day = j.getDay() || 7; // Mon=1 â€¦ Sun=7
  j.setDate(j.getDate() - (day - 1));
  j.setHours(0, 0, 0, 0); return j;
}
function finSemaine(d) {
  const j = debutSemaine(d); j.setDate(j.getDate() + 6); j.setHours(23,59,59,999); return j;
}
function chevaucheFenetre(plage, debut, fin) {
  if (!plage.debut || !plage.fin) return true;
  return plage.debut <= fin && plage.fin >= debut;
}

/** Returns Saturday 00:00 and Sunday 23:59 of the current week. */
function getWeekend() {
  const today = new Date(); today.setHours(0,0,0,0);
  const dow = today.getDay(); // 0=Sun â€¦ 6=Sat
  const sam = new Date(today);
  if (dow === 0) {
    sam.setDate(today.getDate() - 1);   // today is Sunday â†’ Sam = yesterday
  } else {
    sam.setDate(today.getDate() + (6 - dow));  // next (or current) Saturday
  }
  sam.setHours(0,0,0,0);
  const dim = new Date(sam);
  dim.setDate(sam.getDate() + 1);
  dim.setHours(23,59,59,999);
  return { sam, dim };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FAVOURITES  (localStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LS_KEY = 'qef_favoris_v1';
let favoris = new Set(JSON.parse(localStorage.getItem(LS_KEY) || '[]'));

function saveFavoris() { localStorage.setItem(LS_KEY, JSON.stringify([...favoris])); }

function updateFavBadge() {
  const badge = document.getElementById('favBadge');
  const n = favoris.size;
  badge.textContent = n;
  badge.style.opacity = n > 0 ? '1' : '0';
}

function toggleFavori(e, safeUrl) {
  e.preventDefault(); e.stopPropagation();
  const url = decodeURIComponent(safeUrl);
  const btn = e.currentTarget;
  if (favoris.has(url)) {
    favoris.delete(url);
    btn.classList.remove('saved'); btn.innerHTML = '<span class="star">â˜†</span>';
    btn.title = 'Ajouter aux favoris';
    if (currentTab === 'favoris') afficherFavoris();
  } else {
    favoris.add(url);
    btn.classList.add('saved'); btn.innerHTML = '<span class="star">â˜…</span>';
    btn.title = 'Retirer des favoris';
    btn.style.transform = 'scale(1.5)';
    setTimeout(() => { btn.style.transform = ''; }, 220);
  }
  saveFavoris(); updateFavBadge();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARD RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCard(ev) {
  const [lbl] = themeCSS(ev.theme);
  const badge   = ev.date ? `<span class="date-badge">${ev.date}</span>` : '';
  const saved   = favoris.has(ev.URL);
  const safeUrl = encodeURIComponent(ev.URL || '');
  const lieu    = (ev.lieu || '').replace(/,.*/, '').trim() || ev.lieu || '';
  return `<div class="event-card" style="position:relative;border-radius:16px;overflow:hidden;">
    <button class="btn-bookmark${saved?' saved':''}"
            onclick="toggleFavori(event,'${safeUrl}')"
            title="${saved?'Retirer des favoris':'Ajouter aux favoris'}">
      <span class="star">${saved ? 'â˜…' : 'â˜†'}</span>
    </button>
    <a href="${ev.URL||'#'}" target="_blank" rel="noopener noreferrer">
      <div style="position:relative" class="event-card-img">
        <img src="${ev.image||'https://via.placeholder.com/600x300'}"
             style="width:100%;height:188px;object-fit:cover;display:block" alt="${ev.titre}" loading="lazy">
        ${badge}
      </div>
      <div class="card-body">
        <span class="card-theme ${lbl}">${ev.theme||''}</span>
        <h3 class="card-title">${ev.titre}</h3>
        <p class="card-location">ğŸ“ ${lieu}</p>
        <div class="card-spacer"></div>
        <div class="card-footer">
          <span class="card-age">Ã‚ge : ${ev.age}</span>
          <span class="card-prix">${ev.prix}</span>
        </div>
      </div>
    </a>
  </div>`;
}

function emptyState(icon, title, sub) {
  return `<div style="grid-column:1/-1;text-align:center;padding:60px 20px;color:#94a3b8">
    <div style="font-size:3rem;margin-bottom:12px">${icon}</div>
    <p style="font-weight:700;font-size:1.1rem">${title}</p>
    <p style="font-size:0.85rem;margin-top:4px">${sub}</p></div>`;
}

function afficherCartes(liste) {
  document.getElementById('heroCount').textContent = liste.length;
  const grid = document.getElementById('eventGrid');
  grid.innerHTML = liste.length
    ? liste.map(renderCard).join('')
    : emptyState('ğŸ”','Aucune activitÃ© trouvÃ©e','Essayez d\'Ã©largir vos filtres');
}

function afficherFavoris() {
  const liste = tousLesEvenements.filter(ev => favoris.has(ev.URL));
  document.getElementById('favCount').textContent = liste.length;
  const grid = document.getElementById('eventGrid');
  grid.innerHTML = liste.length
    ? liste.map(renderCard).join('')
    : emptyState('â­','Aucun favori pour l\'instant','Cliquez sur â˜† sur une activitÃ© pour la sauvegarder ici');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEE-QENF  â€”  day toggle + sÃ©lection
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let weeDay = 'sam';          // 'sam' | 'dim'
let weeEvtsSam  = [];
let weeEvtsDim  = [];
let weeEvtsBoth = [];        // union for selection scoring

function setWeeDay(day) {
  weeDay = day;
  document.getElementById('btnSam').classList.toggle('active', day === 'sam');
  document.getElementById('btnDim').classList.toggle('active', day === 'dim');
  renderWeeDay();
}

function toggleSelection() {
  const bar  = document.getElementById('selBar');
  const body = document.getElementById('selBody');
  bar.classList.toggle('open');
  body.classList.toggle('open');
}

/** Score an event for the selection: higher = more recommended */
function scoreEvent(ev) {
  let score = 0;
  const { sam, dim } = getWeekend();
  const plage = parsePlage(ev.date || '');

  // 1. Expires this weekend (last day is Saturday or Sunday) â†’ high priority
  if (plage.fin) {
    const samISO = dateISO(sam);
    const dimISO = dateISO(dim);
    const finISO = dateISO(plage.fin);
    if (finISO === samISO || finISO === dimISO) score += 50;
    // Also boost events ending within 7 days of the weekend
    const daysLeft = (plage.fin - sam) / 86400000;
    if (daysLeft >= 0 && daysLeft <= 7) score += 20;
  }

  // 2. Occurs only on one day of the weekend (single-day)
  const onSam = chevaucheFenetre(plage, sam, new Date(sam.getTime() + 86399999));
  const onDim = chevaucheFenetre(plage, new Date(sam.getTime() + 86400000), dim);
  if (onSam !== onDim) score += 30;   // exclusive to one day

  // 3. Variety bonus: identify indoor vs outdoor from lieu/theme
  const txt = ((ev.lieu || '') + ' ' + (ev.theme || '') + ' ' + (ev.titre || '')).toLowerCase();
  const isOutdoor = /parc|plein.air|extÃ©rieur|nature|piste|rue|baie|colline|sentier|ski|glace|patino/i.test(txt);
  ev._outdoor = isOutdoor;   // tag for selection rendering

  return score;
}

/** Render the wide selection card for "Notre sÃ©lection" */
function renderSelCard(ev, rank) {
  const [lbl] = themeCSS(ev.theme);
  const badge   = ev.date ? `<span class="date-badge">${ev.date}</span>` : '';
  const saved   = favoris.has(ev.URL);
  const safeUrl = encodeURIComponent(ev.URL || '');

  // Short summary: use description if available, else generate one from fields
  const desc = (ev.description || '').trim();
  const summary = desc.length > 20
    ? desc.slice(0, 200) + (desc.length > 200 ? 'â€¦' : '')
    : `${ev.theme ? ev.theme.charAt(0).toUpperCase() + ev.theme.slice(1) + ' â€” ' : ''}${ev.lieu || ''}. Public : ${ev.age}.`;

  // Why it's in selection
  const { sam, dim } = getWeekend();
  const plage  = parsePlage(ev.date || '');
  let whyLabel = '';
  if (plage.fin) {
    const finISO = dateISO(plage.fin);
    const samISO = dateISO(sam);
    const dimISO = dateISO(dim);
    if (finISO === samISO || finISO === dimISO) whyLabel = 'Dernier week-end';
    else {
      const daysLeft = (plage.fin - sam) / 86400000;
      if (daysLeft >= 0 && daysLeft <= 7) whyLabel = 'Derniers jours';
    }
  }
  if (!whyLabel) {
    const onSam = chevaucheFenetre(plage, sam, new Date(sam.getTime() + 86399999));
    const onDim = chevaucheFenetre(plage, new Date(sam.getTime() + 86400000), dim);
    if (onSam !== onDim) whyLabel = 'Un seul jour';
  }
  if (!whyLabel) whyLabel = ev._outdoor ? 'Plein air' : 'Ã€ ne pas manquer';

  const whyHtml = `<span class="sel-why">${whyLabel}</span>`;

  return `<div class="sel-card">
    <button class="btn-bookmark${saved?' saved':''}"
            onclick="toggleFavori(event,'${safeUrl}')"
            title="${saved?'Retirer des favoris':'Ajouter aux favoris'}"
            style="z-index:3">
      <span class="star">${saved ? 'â˜…' : 'â˜†'}</span>
    </button>
    <a href="${ev.URL||'#'}" target="_blank" rel="noopener noreferrer"
       style="display:flex;flex:1;text-decoration:none;color:inherit;overflow:hidden;">
      <div class="sel-card-img">
        <img src="${ev.image||'https://via.placeholder.com/600x300'}" alt="${ev.titre}" loading="lazy">
        <div class="sel-rank">${rank}</div>
        ${badge}
      </div>
      <div class="sel-card-body">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <span class="sel-theme ${lbl}">${ev.theme||''}</span>
          ${whyHtml}
        </div>
        <div class="sel-title">${ev.titre}</div>
        <div class="sel-summary">${summary}</div>
        <div class="sel-meta">
          <span class="sel-meta-item">ğŸ“ ${ev.lieu||''}</span>
          <span class="sel-meta-item">Ã‚ge : ${ev.age||'Tous'}</span>
          <span class="sel-prix">${ev.prix||''}</span>
        </div>
      </div>
    </a>
  </div>`;
}

function renderWeeDay() {
  const list   = weeDay === 'sam' ? weeEvtsSam : weeEvtsDim;
  const grid   = document.getElementById('weeDayGrid');
  const { sam, dim } = getWeekend();
  const dimDebut = new Date(sam.getTime() + 86400000); dimDebut.setHours(0,0,0,0);
  const label  = weeDay === 'sam'
    ? `Samedi ${formatDateFR(sam)}`
    : `Dimanche ${formatDateFR(dimDebut)}`;
  const count  = list.length;

  if (!count) {
    grid.innerHTML = `<div class="wee-day-label">${label}</div>` +
      emptyState('ğŸ˜´', 'Aucune activitÃ© ce jour', 'Consultez l\'autre journÃ©e du week-end !');
    return;
  }
  grid.innerHTML =
    `<div class="wee-day-label">${label} <span style="font-size:0.8rem;font-weight:600;color:#64748b;margin-left:6px">${count} activitÃ©${count!==1?'s':''}</span></div>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${list.map(renderCard).join('')}</div>`;
}

function afficherWee() {
  const { sam, dim } = getWeekend();
  const samFin   = new Date(sam); samFin.setHours(23,59,59,999);
  const dimDebut = new Date(sam.getTime() + 86400000); dimDebut.setHours(0,0,0,0);

  document.getElementById('weeDateRange').textContent =
    `Samedi ${formatDateFR(sam)} & Dimanche ${formatDateFR(dimDebut)}`;

  weeEvtsSam  = tousLesEvenements.filter(ev => chevaucheFenetre(parsePlage(ev.date||''), sam,      samFin));
  weeEvtsDim  = tousLesEvenements.filter(ev => chevaucheFenetre(parsePlage(ev.date||''), dimDebut, dim));

  // Union (deduplicated) for scoring
  const seenUrls = new Set();
  weeEvtsBoth = [];
  [...weeEvtsSam, ...weeEvtsDim].forEach(ev => {
    if (!seenUrls.has(ev.URL)) { seenUrls.add(ev.URL); weeEvtsBoth.push(ev); }
  });

  const total = weeEvtsBoth.length;
  document.getElementById('weeCount').textContent =
    `${total} activitÃ©${total !== 1 ? 's' : ''} ce week-end`;

  // Update day-toggle button labels with counts
  document.getElementById('btnSam').textContent = `Samedi (${weeEvtsSam.length})`;
  document.getElementById('btnDim').textContent = `Dimanche (${weeEvtsDim.length})`;

  // Build "Notre sÃ©lection": score + sort + take 10, alternating indoor/outdoor
  const scored = weeEvtsBoth
    .map(ev => ({ ev, score: scoreEvent(ev) }))
    .sort((a, b) => b.score - a.score);

  // Pick up to 10, trying to balance indoor/outdoor (at least 3 of each if available)
  const outdoor = scored.filter(x => x.ev._outdoor);
  const indoor  = scored.filter(x => !x.ev._outdoor);
  const selection = [];
  const used = new Set();
  const addIfNew = ({ ev }) => { if (!used.has(ev.URL)) { used.add(ev.URL); selection.push(ev); } };

  // Take top-scored first, but weave in at least 3 from the minority type
  const minType  = outdoor.length < indoor.length ? outdoor : indoor;
  const majType  = outdoor.length < indoor.length ? indoor  : outdoor;
  let mi = 0, mj = 0;
  while (selection.length < 10 && (mi < minType.length || mj < majType.length)) {
    // ratio: 1 from minority every 3 from majority
    if (mi < minType.length && (selection.length % 3 === 2 || mj >= majType.length)) {
      addIfNew(minType[mi++]);
    } else if (mj < majType.length) {
      addIfNew(majType[mj++]);
    }
  }

  document.getElementById('selGrid').innerHTML = selection.length
    ? selection.map((ev, i) => renderSelCard(ev, i + 1)).join('')
    : `<p style="text-align:center;color:#94a3b8;padding:32px">Aucune activitÃ© ce week-end.</p>`;

  // Render the active day
  renderWeeDay();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OPEN-METEO WEATHER  (no API key needed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WMO_ICON = {
  0:'â˜€ï¸', 1:'ğŸŒ¤ï¸', 2:'â›…', 3:'â˜ï¸',
  45:'ğŸŒ«ï¸', 48:'ğŸŒ«ï¸',
  51:'ğŸŒ¦ï¸', 53:'ğŸŒ¦ï¸', 55:'ğŸŒ§ï¸',
  61:'ğŸŒ§ï¸', 63:'ğŸŒ§ï¸', 65:'ğŸŒ§ï¸',
  71:'ğŸŒ¨ï¸', 73:'ğŸŒ¨ï¸', 75:'â„ï¸', 77:'â„ï¸',
  80:'ğŸŒ¦ï¸', 81:'ğŸŒ§ï¸', 82:'â›ˆï¸',
  85:'ğŸŒ¨ï¸', 86:'â„ï¸',
  95:'â›ˆï¸', 96:'â›ˆï¸', 99:'â›ˆï¸'
};
const WMO_DESC = {
  0:'EnsoleillÃ©', 1:'Peu nuageux', 2:'Partiellement nuageux', 3:'Couvert',
  45:'Brouillard', 48:'Brouillard givrant',
  51:'Bruine lÃ©gÃ¨re', 53:'Bruine', 55:'Bruine forte',
  61:'Pluie lÃ©gÃ¨re', 63:'Pluie modÃ©rÃ©e', 65:'Pluie forte',
  71:'Neige lÃ©gÃ¨re', 73:'Neige modÃ©rÃ©e', 75:'Neige forte', 77:'GrÃ©sil',
  80:'Averses lÃ©gÃ¨res', 81:'Averses', 82:'Averses fortes',
  85:'Averses de neige lÃ©gÃ¨res', 86:'Averses de neige fortes',
  95:'Orage', 96:'Orage avec grÃªle', 99:'Orage violent'
};

// The 4 time-of-day phases: label + representative hour (local)
const PHASES = [
  { label: 'Matin',      hour: 8  },
  { label: 'Midi',       hour: 12 },
  { label: 'AprÃ¨s-midi', hour: 15 },
  { label: 'Soir',       hour: 20 },
];

function cToF(c) { return Math.round(c * 9/5 + 32); }

async function chargerMeteo() {
  try {
    // Request both daily summary AND hourly temps/weathercode
    const url = 'https://api.open-meteo.com/v1/forecast'
      + '?latitude=46.8139&longitude=-71.2080'
      + '&daily=weathercode,temperature_2m_max,temperature_2m_min,'
      + 'precipitation_probability_max,snowfall_sum'
      + '&hourly=temperature_2m,weathercode'
      + '&timezone=America%2FToronto&forecast_days=14';

    const data        = await (await fetch(url)).json();
    const dailyTimes  = data.daily.time;          // ["2026-02-28", â€¦]
    const hourlyTimes = data.hourly.time;          // ["2026-02-28T00:00", â€¦]
    const hourlyTemp  = data.hourly.temperature_2m;
    const hourlyCode  = data.hourly.weathercode;

    const { sam, dim } = getWeekend();
    const dimDebut = new Date(sam.getTime() + 86400000); dimDebut.setHours(0,0,0,0);

    function fillCard(prefix, targetDate) {
      const iso = dateISO(targetDate);            // "2026-02-28"

      // â”€â”€ Daily summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const di = dailyTimes.indexOf(iso);
      if (di === -1) {
        document.getElementById(`${prefix}Icon`).textContent = '?';
        document.getElementById(`${prefix}Cond`).textContent = 'DonnÃ©es indisponibles';
        return;
      }
      const code  = data.daily.weathercode[di];
      const tMaxC = Math.round(data.daily.temperature_2m_max[di]);
      const tMinC = Math.round(data.daily.temperature_2m_min[di]);
      const tMaxF = cToF(data.daily.temperature_2m_max[di]);
      const tMinF = cToF(data.daily.temperature_2m_min[di]);
      const pprob = data.daily.precipitation_probability_max[di];
      const snow  = data.daily.snowfall_sum[di];

      document.getElementById(`${prefix}Date`).textContent   = formatDateFR(targetDate);
      document.getElementById(`${prefix}Icon`).textContent   = WMO_ICON[code] || '?';
      document.getElementById(`${prefix}Temp`).textContent   = `${tMaxC}Â° / ${tMinC}Â° C`;
      document.getElementById(`${prefix}TempF`).textContent  = `${tMaxF}Â° / ${tMinF}Â° F`;
      document.getElementById(`${prefix}Cond`).textContent   = WMO_DESC[code] || '';

      const extra = snow > 0.1
        ? `${snow.toFixed(1)} cm de neige`
        : pprob > 0
          ? `${pprob}% de prÃ©cipitations`
          : 'Pas de prÃ©cipitations';
      document.getElementById(`${prefix}Extra`).textContent = extra;

      // â”€â”€ 4 phases from hourly data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const phaseEl = document.getElementById(`${prefix}Phases`);
      const phaseDivs = phaseEl.querySelectorAll('.mc-phase');

      PHASES.forEach((phase, i) => {
        // Build the ISO datetime string for this phase hour
        const hh   = String(phase.hour).padStart(2, '0');
        const isoH = `${iso}T${hh}:00`;          // "2026-02-28T08:00"
        const hi   = hourlyTimes.indexOf(isoH);

        const div      = phaseDivs[i];
        const iconEl   = div.querySelector('.ph-icon');
        const tempEl   = div.querySelector('.ph-temp');
        const tempFEl  = div.querySelector('.ph-temp-f');

        if (hi === -1) {
          iconEl.textContent  = '?';
          tempEl.textContent  = 'â€”';
          tempFEl.textContent = 'â€”';
          return;
        }

        const hTempC = Math.round(hourlyTemp[hi]);
        const hTempF = cToF(hourlyTemp[hi]);
        const hCode  = hourlyCode[hi];

        iconEl.textContent  = WMO_ICON[hCode] || '?';
        tempEl.textContent  = `${hTempC}Â°C`;
        tempFEl.textContent = `${hTempF}Â°F`;
      });
    }

    fillCard('meteoSam', sam);
    fillCard('meteoDim', dimDebut);

  } catch(err) {
    ['Sam','Dim'].forEach(d => {
      document.getElementById(`meteo${d}Icon`).textContent = '?';
      document.getElementById(`meteo${d}Cond`).textContent = 'MÃ©tÃ©o indisponible';
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentTab = 'events';

function setTab(tab) {
  currentTab = tab;
  const mainHero = document.querySelector('section.bg-blue-600');
  const weeHero  = document.getElementById('weeHero');
  const favHero  = document.getElementById('favHero');
  const weeLabels= document.getElementById('weeLabels');
  const eventGrid= document.getElementById('eventGrid');

  ['events','wee','favoris'].forEach(t =>
    document.getElementById(`tab-${t}`).classList.toggle('active', t === tab));

  mainHero.style.display  = tab === 'events'  ? '' : 'none';
  weeHero.style.display   = tab === 'wee'     ? '' : 'none';
  favHero.style.display   = tab === 'favoris' ? '' : 'none';
  weeLabels.style.display = tab === 'wee'     ? 'block' : 'none';
  eventGrid.style.display = tab === 'wee'     ? 'none' : '';

  window.scrollTo({ top: 0, behavior: 'smooth' });

  if (tab === 'events')  filtrer();
  if (tab === 'favoris') afficherFavoris();
  if (tab === 'wee') {
    weeDay = 'sam';   // reset to Saturday when switching to tab
    document.getElementById('btnSam').classList.add('active');
    document.getElementById('btnDim').classList.remove('active');
    afficherWee();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tousLesEvenements = [];
let fThemes    = new Set();
let fAges      = new Set();
let fPeriode   = '';
let fQuartiers = new Set();
let fTexte     = '';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function norm(s) { return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }

function filtrer() {
  const now   = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  let fD = null, fF = null;

  if (fPeriode === 'today') {
    fD = today; fF = new Date(today); fF.setHours(23,59,59,999);
  } else if (fPeriode === 'week') {
    fD = debutSemaine(today); fF = finSemaine(today);
  } else if (fPeriode === 'month') {
    fD = new Date(now.getFullYear(), now.getMonth(), 1);
    fF = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
  } else if (fPeriode === 'nextmonth') {
    fD = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    fF = new Date(now.getFullYear(), now.getMonth() + 2, 0, 23, 59, 59);
  }

  const result = tousLesEvenements.filter(ev => {
    if (fThemes.size > 0 && ![...fThemes].some(t => norm(ev.theme) === norm(t))) return false;
    if (fAges.size > 0) {
      const a = norm(ev.age);
      if (a !== 'tous') {
        const n = parseInt((a.match(/\d+/)||['99'])[0]);
        const ok = [...fAges].some(r => {
          if (r==='0-3')  return n<=3;
          if (r==='3-5')  return n>=3&&n<=6;
          if (r==='6-12') return n>=5&&n<=12;
          if (r==='13+')  return n>=12;
          return false;
        });
        if (!ok) return false;
      }
    }
    if (fD && fF && !chevaucheFenetre(parsePlage(ev.date||''), fD, fF)) return false;
    if (fQuartiers.size > 0 && ![...fQuartiers].some(q => norm(q)===norm(ev.quartier))) return false;
    if (fTexte && !norm((ev.titre||'')+' '+(ev.description||'')).includes(fTexte)) return false;
    return true;
  });

  afficherCartes(result);
  updateSummary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIVE FILTER SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const THEME_LBL  = {'arts':'ğŸ¨ Arts','cinÃ©ma':'ğŸ¬ CinÃ©ma','visite guidÃ©e':'ğŸ› Visites','musique':'ğŸµ Musique','spectacle':'ğŸ­ Spectacles','Ã©vÃ©nement spÃ©cial':'â­ Ã‰vÃ©nements','exposition':'ğŸ–¼ Expos','sport':'âš½ Sport'};
const AGE_LBL    = {'0-3':'0â€“3 ans','3-5':'3â€“5 ans','6-12':'6â€“12 ans','13+':'13 ans +'};
const PERIOD_LBL = {'today':"Aujourd'hui",'week':'Cette semaine','month':'Ce mois','nextmonth':'Mois prochain'};

function updateSummary() {
  const bar = document.getElementById('summaryBar');
  const chips = document.getElementById('summaryChips');
  const tags = [];

  fThemes.forEach(v    => tags.push({label:THEME_LBL[v]||v,         rm:()=>{fThemes.delete(v);    ddTheme.reset();    filtrer();}}));
  fAges.forEach(v      => tags.push({label:AGE_LBL[v]||v,           rm:()=>{fAges.delete(v);      ddAge.reset();      filtrer();}}));
  if (fPeriode)          tags.push({label:PERIOD_LBL[fPeriode]||fPeriode, rm:()=>{fPeriode='';ddPeriode.reset();      filtrer();}});
  fQuartiers.forEach(v => tags.push({label:v,                        rm:()=>{fQuartiers.delete(v); ddQuartier.reset(); filtrer();}}));
  if (fTexte)            tags.push({label:`"${fTexte}"`,             rm:()=>{fTexte='';syncTexte('');                 filtrer();}});

  if (!tags.length) { bar.classList.add('hidden'); bar.classList.remove('flex'); return; }
  bar.classList.remove('hidden'); bar.classList.add('flex');
  chips.innerHTML = tags.map((t,i) =>
    `<span class="chip">${t.label}<button class="chip-x" data-i="${i}">âœ•</button></span>`).join('');
  chips.querySelectorAll('.chip-x').forEach(b =>
    b.addEventListener('click', () => tags[+b.dataset.i].rm()));
}

function syncTexte(val) { document.getElementById('filtreTexte').value = val; }

function clearAll() {
  fThemes.clear(); fAges.clear(); fPeriode=''; fQuartiers.clear(); fTexte='';
  ddTheme.reset(); ddAge.reset(); ddPeriode.reset(); ddQuartier.reset();
  syncTexte(''); filtrer();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT DROPDOWNS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ddTheme    = new Dropdown('dd-theme',    'multi',  sel => { fThemes    = sel; filtrer(); });
const ddAge      = new Dropdown('dd-age',      'multi',  sel => { fAges      = sel; filtrer(); });
const ddPeriode  = new Dropdown('dd-periode',  'single', val => { fPeriode   = val; filtrer(); });
const ddQuartier = new Dropdown('dd-quartier', 'multi',  sel => { fQuartiers = sel; filtrer(); });

document.getElementById('filtreTexte').addEventListener('input', e => {
  fTexte = norm(e.target.value); filtrer();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function chargerDonnees() {
  try {
    const reponse = await fetch('./evenements.json');
    if (!reponse.ok) throw new Error('Fichier introuvable (404)');
    tousLesEvenements = await reponse.json();
    afficherCartes(tousLesEvenements);
    updateFavBadge();
  } catch (err) {
    document.getElementById('eventGrid').innerHTML =
      `<p class="text-center col-span-full text-red-400">Erreur : ${err.message}</p>`;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  chargerDonnees();
  chargerMeteo(); // pre-fetch mÃ©tÃ©o so it's ready when user clicks Wee tab
});
</script>
</body>
</html>
